/Users/tim/projects/crystal_public/apps/crystal
msp430-gcc (GCC) 4.6.3 20120301 (mspgcc LTS 20120406 unpatched)
Copyright (C) 2011 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

declare -x AKKA_CLASSPATH="/Users/tim/projects/akka-2.4.14/lib/*:/Users/tim/projects/akka-2.4.14/config:/Users/tim/projects/akka-2.4.14/lib/akka/*"
declare -x AKKA_HOME="/Users/tim/projects/akka-2.4.14"
declare -x Apple_PubSub_Socket_Render="/private/tmp/com.apple.launchd.XYsNo74SLg/Render"
declare -x CFLAGS="-DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0"
declare -x CONTIKI="/Users/tim/projects/contiki"
declare -x EDITOR="vim"
declare -x HOME="/Users/tim"
declare -x LC_ALL="en_US.UTF-8"
declare -x LC_CTYPE="UTF-8"
declare -x LESS="-R"
declare -x LOGNAME="tim"
declare -x LSCOLORS="Gxfxcxdxbxegedabagacad"
declare -x OLDPWD
declare -x PAGER="less"
declare -x PATH="/Users/tim/sw/gcc-arm/bin:/opt/local/bin:/opt/local/sbin:/Users/tim/projects/tos-tools/bin:/Users/tim/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Library/TeX/texbin:/Applications/Wireshark.app/Contents/MacOS"
declare -x PWD="/Users/tim/projects/crystal_public/apps/crystal"
declare -x SECURITYSESSIONID="186a6"
declare -x SHELL="/bin/zsh"
declare -x SHLVL="3"
declare -x SSH_AUTH_SOCK="/private/tmp/com.apple.launchd.lb4TNNBDkW/Listeners"
declare -x TERM="xterm-256color"
declare -x TERM_PROGRAM="Apple_Terminal"
declare -x TERM_PROGRAM_VERSION="361.1"
declare -x TERM_SESSION_ID="1ADD2445-302B-4324-ADD0-DE40DEC545F2"
declare -x TINYOS_ROOT_DIR="/Users/tim/projects/tinyos"
declare -x TMPDIR="/var/folders/fj/b3w4p5ln3jj5lsbhbt7ltvvh0000gn/T/"
declare -x USER="tim"
declare -x XPC_FLAGS="0x0"
declare -x XPC_SERVICE_NAME="0"
declare -x ZSH="/Users/tim/.oh-my-zsh"
declare -x __CF_USER_TEXT_ENCODING="0x1F5:0x0:0x0"
-- git status -------
7384f4fefbc2c650c936544a2939a468df278317
 D apps/crystal/app-ipsn18.c
 D apps/crystal/app-ipsn18.h
 M apps/crystal/app.c
 M apps/crystal/app.h
 D apps/crystal/build_cooja.sh
 M apps/crystal/chseq.c
 M apps/crystal/crystal.c
 M apps/crystal/crystal.h
 D apps/crystal/mrm.csc
 D apps/crystal/mrm_bad_links.csc
 D apps/crystal/mrm_big.csc
 M core/dev/glossy.c
 M core/dev/glossy.h
 M cpu/msp430/leds-arch.c
 M cpu/msp430/msp430.c
 M platform/sky/Makefile.sky
 M platform/sky/contiki-sky-main.c
 M platform/sky/dev/xmem.c
?? apps/crystal/app-depcomp-default.c
?? apps/crystal/app-depcomp-default.h
?? apps/crystal/build_cooja_depcomp.sh
?? apps/crystal/crystal.S
?? apps/crystal/crystal.sky.env
?? apps/crystal/depcomp-pins.c
?? apps/crystal/depcomp.csc
?? apps/crystal/sndtbl.c
?? apps/crystal/symbols.c
?? apps/crystal/symbols.h
?? exps/regression/
?? exps/z_/
?? test_tools/simgen_depcomp.py
diff --git a/apps/crystal/app-ipsn18.c b/apps/crystal/app-ipsn18.c
deleted file mode 100644
index 920b7b3..0000000
--- a/apps/crystal/app-ipsn18.c
+++ /dev/null
@@ -1,123 +0,0 @@
-#include "sndtbl.c"
-
-static uint16_t app_have_packet;
-static uint16_t app_seqn;
-static uint16_t app_log_seqn;
-static uint16_t app_n_packets;
-
-#define PACKETS_PER_EPOCH 1
-
-#if CRYSTAL_LOGGING
-struct pkt_record {
-  uint16_t seqn;
-  uint16_t acked;
-  
-} app_packets[PACKETS_PER_EPOCH];
-#endif //CRYSTAL_LOGGING
-
-
-static void app_init() {
-}
-
-static inline void app_pre_S() {
-  app_have_packet = 0;
-  log_send_seqn = 0;
-  app_n_packets = 0;
-}
-
-static inline void app_new_packet() {
-  app_seqn ++;
-#if CRYSTAL_LOGGING
-  app_packets[app_n_packets].seqn = app_seqn;
-  app_packets[app_n_packets].acked = 0;
-#endif //CRYSTAL_LOGGING
-  app_n_packets ++;
-}
-
-static inline void app_mark_acked() {
-#if CRYSTAL_LOGGING
-  app_packets[app_n_packets-1].acked = 1;
-#endif //CRYSTAL_LOGGING
-}
-
-static inline void app_post_S(int received) {
-  if (IS_SINK())
-    return;
-#if CONCURRENT_TXS > 0
-  int i;
-  int cur_idx;
-  if (epoch >= START_EPOCH) {
-    cur_idx = ((epoch - START_EPOCH) % NUM_ACTIVE_EPOCHS) * CONCURRENT_TXS;
-    for (i=0; i<CONCURRENT_TXS; i++) {
-      if (node_id == sndtbl[cur_idx + i]) {
-        app_have_packet = 1;
-        app_new_packet();
-        break;
-      }
-    }
-  }
-#endif // CONCURRENT_TXS
-}
-
-static inline int app_pre_T() {
-  log_send_acked = 0;
-  if (app_have_packet) {
-    crystal_data->app.seqn = app_seqn;
-    crystal_data->app.src = node_id;
-    log_send_seqn = app_seqn;  // for logging
-    return 1;
-  }
-  return 0;
-}
-
-static inline void app_between_TA(int received) {
-  if (received) {
-    log_recv_src = crystal_data->app.src;
-    log_recv_seqn = crystal_data->app.seqn;
-    if (IS_SINK()) {
-      // fill in the ack payload
-      crystal_ack->app.seqn=log_recv_seqn;
-      crystal_ack->app.src=log_recv_src;
-    }
-  }
-  else {
-    crystal_ack->app.seqn=NO_SEQN;
-    crystal_ack->app.src=NO_NODE;
-  }
-}
-
-static inline void app_post_A(int received) {
-  // non-sink: if acked us, stop sending data
-  log_send_acked = 0;
-  if (app_have_packet && received) {
-    if ((crystal_ack->app.src == node_id) && (crystal_ack->app.seqn == app_seqn)) {
-      log_send_acked = 1;
-      app_mark_acked();
-      if (app_n_packets < PACKETS_PER_EPOCH) {
-        app_new_packet();
-      }
-      else {
-        app_have_packet = 0;
-      }
-    }
-  }
-}
-
-
-static inline void app_epoch_end() {}
-static inline void app_ping() {}
-
-#if CRYSTAL_LOGGING
-void app_print_logs() {
-  if (!IS_SINK()) {
-    int i;
-    for (i=0; i<app_n_packets; i++) {
-      printf("A %u:%u %u %u\n", epoch, 
-          app_packets[i].seqn, 
-          app_packets[i].acked, 
-          app_log_seqn);
-      app_log_seqn ++;
-    }
-  }
-}
-#endif //CRYSTAL_LOGGING
diff --git a/apps/crystal/app-ipsn18.h b/apps/crystal/app-ipsn18.h
deleted file mode 100644
index f6e0706..0000000
--- a/apps/crystal/app-ipsn18.h
+++ /dev/null
@@ -1,22 +0,0 @@
-#define NO_NODE 0
-#define NO_SEQN 65535
-
-typedef struct {
-} 
-__attribute__((packed))
-app_s_payload;
-
-typedef struct {
-  crystal_addr_t src;
-  uint16_t seqn;
-  uint8_t payload[CRYSTAL_PAYLOAD_LENGTH];
-} 
-__attribute__((packed))
-app_t_payload;
-
-typedef struct {
-  crystal_addr_t src;
-  uint16_t seqn;
-} 
-__attribute__((packed))
-app_a_payload;
diff --git a/apps/crystal/app.c b/apps/crystal/app.c
index 7c90a57..2157709 100644
--- a/apps/crystal/app.c
+++ b/apps/crystal/app.c
@@ -1,6 +1,8 @@
 #if DEPCOMP18
-#include "app-depcomp.c"
+#include "app-depcomp-default.c"
+//#include "app-depcomp-tssimple.c"
+//#include "app-depcomp-reorder.c"
 #else
-#include "app-ipsn18.c"
+#include "app-sensys.c"
 #endif
 
diff --git a/apps/crystal/app.h b/apps/crystal/app.h
index 2cda065..d51d4c9 100644
--- a/apps/crystal/app.h
+++ b/apps/crystal/app.h
@@ -1,8 +1,10 @@
 #ifndef APP_H
 #define APP_H
 #if DEPCOMP18
-#include "app-depcomp.h"
+#include "app-depcomp-default.h"
+//#include "app-depcomp-tssimple.h"
+//#include "app-depcomp-reorder.h"
 #else
-#include "app-ipsn18.h"
+#include "app-sensys.h"
 #endif
 #endif //APP_H
diff --git a/apps/crystal/build_cooja.sh b/apps/crystal/build_cooja.sh
deleted file mode 100755
index 3609446..0000000
--- a/apps/crystal/build_cooja.sh
+++ /dev/null
@@ -1,36 +0,0 @@
-#!/bin/bash
-
-# set to 1 for motelab testbeds
-#export CFLAGS="$CFLAGS -DTINYOS_SERIAL_FRAMES=1"
-
-# set COOJA to 1 for simulating Glossy in Cooja
-export CFLAGS="$CFLAGS -DCOOJA=1"
-export CFLAGS="$CFLAGS -DDISABLE_ETIMER=1"
-
-export CFLAGS="$CFLAGS -DCRYSTAL_CONF_PERIOD=1"
-export CFLAGS="$CFLAGS -DCRYSTAL_LOGGING=1"
-export CFLAGS="$CFLAGS -DDISABLE_UART=0"
-export CFLAGS="$CFLAGS -DCRYSTAL_SINK_ID=1" 
-export CFLAGS="$CFLAGS -DSTART_EPOCH=1" 
-export CFLAGS="$CFLAGS -DN_FULL_EPOCHS=10"
-
-export CFLAGS="$CFLAGS -DTX_POWER=31 -DRF_CHANNEL=26 -DCONCURRENT_TXS=5 -DNUM_ACTIVE_EPOCHS=1 -DN_TX_S=5 -DN_TX_T=5 -DN_TX_A=5 -DDUR_S_MS=12 -DDUR_T_MS=10 -DDUR_A_MS=12 -DCRYSTAL_LONGSKIP=0 -DCRYSTAL_SYNC_ACKS=1"
-export CFLAGS="$CFLAGS -DCRYSTAL_SINK_MAX_EMPTY_TS=2 -DCRYSTAL_MAX_SILENT_TAS=2 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6"
-export CFLAGS="$CFLAGS -DCRYSTAL_USE_DYNAMIC_NEMPTY=0"
-export CFLAGS="$CFLAGS -DCCA_THRESHOLD=-32 -DCCA_COUNTER_THRESHOLD=80"
-export CFLAGS="$CFLAGS -DCRYSTAL_PAYLOAD_LENGTH=2"
-#export CFLAGS="$CFLAGS -DSHORT_LOGS=1"
-
-#export CFLAGS="$CFLAGS -DCHHOP_MAPPING=CHMAP_nohop"
-export CFLAGS="$CFLAGS -DCHHOP_MAPPING=CHMAP_nomap"
-#export CFLAGS="$CFLAGS -DBOOT_CHOPPING=BOOT_nohop"
-export CFLAGS="$CFLAGS -DBOOT_CHOPPING=BOOT_hop3"
-
-export CFLAGS="$CFLAGS -DCRYSTAL_START_DELAY_NONSINK=0 -DCRYSTAL_START_DELAY_SINK=0"
-
-cp sndtbl_cooja.c sndtbl.c
-
-make clean
-rm crystal.sky
-
-make 
diff --git a/apps/crystal/chseq.c b/apps/crystal/chseq.c
index 9ab1be4..f8e208f 100644
--- a/apps/crystal/chseq.c
+++ b/apps/crystal/chseq.c
@@ -53,10 +53,10 @@ static inline int get_channel_epoch(crystal_epoch_t epoch) {
 
 static inline int get_channel_epoch_ta(crystal_epoch_t epoch, uint8_t ta) {
   //return channel_array[((epoch + 3 + ta)*7) % get_num_channels()];
+  //return channel_array[((epoch + ta)*7 + epoch) % get_num_channels()];
   return channel_array[((7*epoch + ta + 1)*7)% get_num_channels()];
 }
 
-enum scan_rx {SCAN_RX_NOTHING, SCAN_RX_S, SCAN_RX_A};
 
 #if BOOT_CHOPPING == BOOT_nohop
 static inline int get_channel_node_bootstrap(){
@@ -64,6 +64,7 @@ static inline int get_channel_node_bootstrap(){
 }
 #elif BOOT_CHOPPING == BOOT_hop3
 
+enum scan_rx {SCAN_RX_NOTHING, SCAN_RX_S, SCAN_RX_A};
 enum scan_state {SCAN_ST_CHASE_S, SCAN_ST_SEARCH} scan_state;
 
 static uint32_t        scan_last_hop_ago;
@@ -73,27 +74,19 @@ static uint8_t         scan_epoch_misses;
 static uint8_t         scan_last_ch_index;
 
 #define SCAN_MAX_S_MISSES 5
-#define SCAN_START_CHASING_S 0
 
 static inline int get_channel_node_bootstrap(enum scan_rx rx){
   static first_time = 1;
 
   if (first_time) {// first time 
-    first_time = 0;
     scan_last_check_time = RTIMER_NOW();
-#if SCAN_START_CHASING_S
     // root starts with epoch 1, so if we all start roughly at the same time, we'll use the same channel.
     scan_last_epoch = 1;
     scan_state = SCAN_ST_CHASE_S;
+    first_time = 0;
     // we might be late for the first S, try it but change to the next one in half-epoch time
     scan_last_hop_ago = CRYSTAL_PERIOD / 2;
     return get_channel_epoch(scan_last_epoch);
-#else // SCAN_START_CHASING_S
-    scan_last_ch_index = 0;
-    scan_state = SCAN_ST_SEARCH;
-    scan_last_hop_ago = 0;
-    return channel_array[scan_last_ch_index];
-#endif // SCAN_START_CHASING_S
   }
 
   scan_last_hop_ago += RTIMER_NOW() - scan_last_check_time;
diff --git a/apps/crystal/crystal.c b/apps/crystal/crystal.c
index 57d909f..4bceef4 100644
--- a/apps/crystal/crystal.c
+++ b/apps/crystal/crystal.c
@@ -1,44 +1,8 @@
-/*
- * Copyright (c) 2018, University of Trento, Italy and 
- * Fondazione Bruno Kessler, Trento, Italy.
- *
- * All rights reserved.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the above copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- * 3. Neither the name of the copyright holders nor the names of its 
- *    contributors may be used to endorse or promote products derived from this 
- *    software without specific prior written permission.
- *
- * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND
- * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
- * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
- * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE
- * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
- * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
- * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
- * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
- * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
- * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
- * SUCH DAMAGE.
- *
- * Authors: Timofei Istomin <tim.ist@gmail.com>
- *          Matteo Trobinger <matteo.trobinger@unitn.it>
- *
- */
-
-
-
 #include "crystal.h"
 #include "cc2420.h"
 #include "node-id.h"
 #include "ds2411.h"
+#include "random.h"
 
 #include "packets.h"
 
@@ -80,6 +44,7 @@ rtimer_clock_t corrected_ref_time;   // reference time acquired during the S or
 rtimer_clock_t skewed_ref_time;      // reference time in the local time frame
 
 crystal_epoch_t epoch;        // epoch seqn received from the sink (or extrapolated)
+uint8_t bs_done;      // done the bootstrapping of Crystal
 
 uint16_t correct_packet; // whether the received packet is correct
 
@@ -159,8 +124,7 @@ uint16_t log_send_acked;
 #define N_MISSED_FOR_INIT_GUARD 3
 
 #define N_SILENT_EPOCHS_TO_RESET 100
-#define N_SILENT_EPOCHS_TO_STOP_SENDING 3
-
+#define N_SILENT_EPOCHS_TO_STOP_SENDING 10 // used 3 for IPSN'18
 #define SYSTEM_RESET() do {WDTCTL = 0;} while(0)
 
 #define APP_PING_INTERVAL (RTIMER_SECOND / 31) // 32 ms
@@ -187,6 +151,7 @@ struct send_info {
 
 
 #if CRYSTAL_LOGGING
+static uint16_t print_epoch;
 #define MAX_LOG_TAS 100
 struct recv_info recv_t[MAX_LOG_TAS];
 int n_rec_rx; // number of receive records in the array
@@ -352,8 +317,11 @@ char sink_timer_handler(struct rtimer *t, void *ptr) {
     rtimer_set(t, t_phase_start - (GLOSSY_PRE_TIME + 16), timer_handler, ptr);
     PT_YIELD(&pt);
 
-    epoch ++;
-    crystal_sync->epoch = epoch;
+    CRYSTAL_INC_EPOCH(epoch);
+    if (epoch >= N_FULL_EPOCHS)
+      bs_done = CRYSTAL_BS_DONE_FLAG; // ended the full-epoch bootstrap
+
+    crystal_sync->epoch = epoch | bs_done;
     crystal_sync->src = node_id;
     t_phase_stop = t_phase_start + DUR_S;
 
@@ -367,9 +335,7 @@ char sink_timer_handler(struct rtimer *t, void *ptr) {
     glossy_start(&glossy_S, (uint8_t *)crystal_sync, CRYSTAL_SYNC_LEN,
         GLOSSY_INITIATOR, channel, GLOSSY_SYNC, N_TX_S,
         0, // don't stop on sync
-        CRYSTAL_TYPE_SYNC, 
-        0, // don't ignore type
-        t_phase_start, t_phase_stop, timer_handler, t, ptr);
+        CRYSTAL_TYPE_SYNC, t_phase_start, t_phase_stop, timer_handler, t, ptr);
     // Yield the protothread. It will be resumed when Glossy terminates.
     PT_YIELD(&pt);
 
@@ -390,109 +356,107 @@ char sink_timer_handler(struct rtimer *t, void *ptr) {
     n_ta = 0;
     sleep_order = 0;
     log_recv_err = 0;
-    while (!sleep_order && n_ta < CRYSTAL_MAX_TAS) {
+    if (1/*epoch >= START_EPOCH*/) {
+      while (!sleep_order && n_ta < CRYSTAL_MAX_TAS) {
 
 // -- Phase T (root) ----------------------------------------------------------------- T (root) ---
-      t_phase_start = ref_time - CRYSTAL_SHORT_GUARD + PHASE_T_OFFS(n_ta);
-      t_phase_stop = t_phase_start + DUR_T + CRYSTAL_SHORT_GUARD + CRYSTAL_SINK_END_GUARD;
+        t_phase_start = ref_time - CRYSTAL_SHORT_GUARD + PHASE_T_OFFS(n_ta);
+        t_phase_stop = t_phase_start + DUR_T + CRYSTAL_SHORT_GUARD + CRYSTAL_SINK_END_GUARD;
 
-      channel = get_channel_epoch_ta(epoch, n_ta);
+        channel = get_channel_epoch_ta(epoch, n_ta);
 
-      app_pre_T();
+        app_pre_T();
 
-      glossy_start(&glossy_T, (uint8_t *)crystal_data, CRYSTAL_DATA_LEN,
-          GLOSSY_RECEIVER, channel, GLOSSY_NO_SYNC, N_TX_T,
-          0, // don't stop on sync
-          CRYSTAL_TYPE_DATA, 
-          0, // don't ignore type
-          t_phase_start, t_phase_stop, timer_handler, t, ptr);
+        glossy_start(&glossy_T, (uint8_t *)crystal_data, CRYSTAL_DATA_LEN,
+            GLOSSY_RECEIVER, channel, GLOSSY_NO_SYNC, N_TX_T,
+            0, // don't stop on sync
+            CRYSTAL_TYPE_DATA, t_phase_start, t_phase_stop, timer_handler, t, ptr);
 
-      PT_YIELD(&pt);
-      glossy_stop();
-      ton_t += get_rtx_on();
-      UPDATE_TF(tf_t, n_short_t, 0, N_TX_T);
-      
-      correct_packet = 0;
-      cca_busy_cnt = get_cca_busy_cnt();
-      log_recv_src = 0;
-      if (get_rx_cnt()) { // received data
-        n_empty_ts = 0;
-        n_high_noise = 0;
-        log_recv_type = get_app_header();
-        log_recv_length = get_data_len();
-        correct_packet = (log_recv_length == CRYSTAL_DATA_LEN && log_recv_type == CRYSTAL_TYPE_DATA);
-        log_recv_err = correct_packet?0:CRYSTAL_BAD_DATA;
-      }
-      else if (is_corrupted()) {
-        n_empty_ts = 0;
-        n_high_noise = 0;
-        log_recv_type = 0;
-        log_recv_seqn = 0;
-        log_recv_length = 0;
-        log_recv_err = CRYSTAL_BAD_CRC;
-      }
+        PT_YIELD(&pt);
+        glossy_stop();
+        ton_t += get_rtx_on();
+        UPDATE_TF(tf_t, n_short_t, 0, N_TX_T);
+        
+        correct_packet = 0;
+        cca_busy_cnt = get_cca_busy_cnt();
+        log_recv_src = 0;
+        if (get_rx_cnt()) { // received data
+          n_empty_ts = 0;
+          n_high_noise = 0;
+          log_recv_type = get_app_header();
+          log_recv_length = get_data_len();
+          correct_packet = (log_recv_length == CRYSTAL_DATA_LEN && log_recv_type == CRYSTAL_TYPE_DATA);
+          log_recv_err = correct_packet?0:CRYSTAL_BAD_DATA;
+        }
+        else if (is_corrupted()) {
+          n_empty_ts = 0;
+          n_high_noise = 0;
+          log_recv_type = 0;
+          log_recv_seqn = 0;
+          log_recv_length = 0;
+          log_recv_err = CRYSTAL_BAD_CRC;
+        }
 #if (CRYSTAL_SINK_MAX_NOISY_TS > 0)
-      else if (cca_busy_cnt > CCA_COUNTER_THRESHOLD) {
-        //n_empty_ts = 0; // should we reset it, it's a good question
-        n_high_noise ++;
-        log_recv_type = 0;
-        log_recv_seqn = 0;
-        log_recv_length = cca_busy_cnt;
-        log_recv_err = CRYSTAL_HIGH_NOISE;
-      }
+        else if (cca_busy_cnt > CCA_COUNTER_THRESHOLD) {
+          //n_empty_ts = 0; // should we reset it, it's a good question
+          n_high_noise ++;
+          log_recv_type = 0;
+          log_recv_seqn = 0;
+          log_recv_length = cca_busy_cnt;
+          log_recv_err = CRYSTAL_HIGH_NOISE;
+        }
 #endif
-      else {
-        // just silence
-        n_high_noise = 0;
-        n_empty_ts ++;
-        // logging for debugging
-        log_recv_type = 0;
-        log_recv_seqn = 0;
-        log_recv_length = cca_busy_cnt;
-        log_recv_err = CRYSTAL_SILENCE;
-      }
+        else {
+          // just silence
+          n_high_noise = 0;
+          n_empty_ts ++;
+          // logging for debugging
+          log_recv_type = 0;
+          log_recv_seqn = 0;
+          log_recv_length = cca_busy_cnt;
+          log_recv_err = CRYSTAL_SILENCE;
+        }
 
-      app_between_TA(correct_packet);
-      log_ta_rx();
-      //BZERO_BUF(); // cannot zero out as it has data for A
+        app_between_TA(correct_packet);
+        log_ta_rx();
+        //BZERO_BUF(); // cannot zero out as it has data for A
 // -- Phase T end (root) --------------------------------------------------------- T end (root) ---
-      sleep_order = 
-        epoch >= N_FULL_EPOCHS && (
-        (n_ta         >= CRYSTAL_MAX_TAS-1) || 
-        (n_empty_ts   >= CRYSTAL_SINK_MAX_EMPTY_TS_DYNAMIC(n_ta)) || 
-        (CRYSTAL_SINK_MAX_NOISY_TS && n_high_noise >= CRYSTAL_SINK_MAX_NOISY_TS)// && (n_high_noise >= CRYSTAL_SINK_MAX_EMPTY_TS_DYNAMIC(n_ta))
-      );
+        sleep_order = 
+          bs_done && (
+          (n_ta         >= CRYSTAL_MAX_TAS-1) || 
+          (n_empty_ts   >= CRYSTAL_SINK_MAX_EMPTY_TS_DYNAMIC(n_ta)) || 
+          (CRYSTAL_SINK_MAX_NOISY_TS && n_high_noise >= CRYSTAL_SINK_MAX_NOISY_TS)// && (n_high_noise >= CRYSTAL_SINK_MAX_EMPTY_TS_DYNAMIC(n_ta))
+        );
 // -- Phase A (root) ----------------------------------------------------------------- A (root) ---
 
-      if (sleep_order)
-        CRYSTAL_SET_ACK_SLEEP(crystal_ack);
-      else
-        CRYSTAL_SET_ACK_AWAKE(crystal_ack);
-      
-      crystal_ack->n_ta = n_ta;
-      crystal_ack->epoch = epoch;
-      t_phase_start = ref_time + PHASE_A_OFFS(n_ta);
-      t_phase_stop = t_phase_start + DUR_A;
-
-      glossy_start(&glossy_A, (uint8_t *)crystal_ack, CRYSTAL_ACK_LEN,
-          GLOSSY_INITIATOR, channel, CRYSTAL_SYNC_ACKS, N_TX_A,
-          0, // don't stop on sync
-          CRYSTAL_TYPE_ACK, 
-          0, // don't ignore type
-          t_phase_start, t_phase_stop, timer_handler, t, ptr);
-
-      PT_YIELD(&pt);
-      glossy_stop();
-      ton_a += get_rtx_on();
-      UPDATE_TF(tf_a, n_short_a, 1, N_TX_A);
-
-      app_post_A(0);
-      BZERO_BUF();
+        if (sleep_order)
+          CRYSTAL_SET_ACK_SLEEP(crystal_ack);
+        else
+          CRYSTAL_SET_ACK_AWAKE(crystal_ack);
+        
+        crystal_ack->n_ta = n_ta;
+        crystal_ack->epoch = epoch | bs_done;
+        t_phase_start = ref_time + PHASE_A_OFFS(n_ta);
+        t_phase_stop = t_phase_start + DUR_A;
+
+        glossy_start(&glossy_A, (uint8_t *)crystal_ack, CRYSTAL_ACK_LEN,
+            GLOSSY_INITIATOR, channel, CRYSTAL_SYNC_ACKS, N_TX_A,
+            0, // don't stop on sync
+            CRYSTAL_TYPE_ACK, t_phase_start, t_phase_stop, timer_handler, t, ptr);
+
+        PT_YIELD(&pt);
+        glossy_stop();
+        ton_a += get_rtx_on();
+        UPDATE_TF(tf_a, n_short_a, 1, N_TX_A);
+
+        app_post_A(0);
+        BZERO_BUF();
 // -- Phase A end (root) --------------------------------------------------------- A end (root) ---
 
-      n_ta ++;
+        n_ta ++;
+      }
+      app_epoch_end();
     }
-    app_epoch_end();
 
     cc2420_oscoff(); // put radio to deep sleep
 
@@ -537,8 +501,6 @@ char nonsink_timer_handler(struct rtimer *t, void *ptr) {
   PT_YIELD(&pt);
 #endif
   channel = get_channel_node_bootstrap(SCAN_RX_NOTHING);
-
-  // Scanning loop
   while (1) {
     bzero(&glossy_S, sizeof(glossy_S)); // reset the Glossy timing info
     t_phase_start = RTIMER_NOW() + (GLOSSY_PRE_TIME + 6); // + 6 is just to be sure
@@ -548,9 +510,7 @@ char nonsink_timer_handler(struct rtimer *t, void *ptr) {
         GLOSSY_RECEIVER, channel, GLOSSY_SYNC, 5 /* N */,
         //1, // stop immediately on sync
         0, // don't stop on sync
-        0, // don't specify packet type
-        1, // ignore type (receive anything)
-        t_phase_start, t_phase_stop, timer_handler, t, ptr);
+        CRYSTAL_TYPE_SYNC, t_phase_start, t_phase_stop, timer_handler, t, ptr);
     PT_YIELD(&pt);
     glossy_stop();
 
@@ -562,7 +522,8 @@ char nonsink_timer_handler(struct rtimer *t, void *ptr) {
       if (recvtype_s == CRYSTAL_TYPE_SYNC && 
           recvlen_s  == CRYSTAL_SYNC_LEN  &&
           crystal_sync->src  == CRYSTAL_SINK_ID) {
-        epoch = crystal_sync->epoch;
+        epoch = CRYSTAL_GET_EPOCH(crystal_sync->epoch);
+        bs_done = CRYSTAL_GET_BS_DONE(crystal_sync->epoch);
         n_ta = 0;
         if (IS_SYNCED()) {
           corrected_ref_time = get_t_ref_l();
@@ -574,7 +535,8 @@ char nonsink_timer_handler(struct rtimer *t, void *ptr) {
       // Ack packet received
       else if (recvtype_s == CRYSTAL_TYPE_ACK && 
                recvlen_s  == CRYSTAL_ACK_LEN) {
-        epoch = crystal_ack->epoch;
+        epoch = CRYSTAL_GET_EPOCH(crystal_ack->epoch);
+        bs_done = CRYSTAL_GET_BS_DONE(crystal_ack->epoch);
         n_ta = crystal_ack->n_ta;
         if (IS_SYNCED()) {
           corrected_ref_time = get_t_ref_l() - PHASE_A_OFFS(n_ta);
@@ -595,7 +557,7 @@ char nonsink_timer_handler(struct rtimer *t, void *ptr) {
     }
     channel = get_channel_node_bootstrap(SCAN_RX_NOTHING);
   }
-
+  
   if (recvtype_s != CRYSTAL_TYPE_SYNC)
     bzero(&glossy_S, sizeof(glossy_S)); // reset the timing info if a non-S packet was received
 
@@ -612,7 +574,10 @@ char nonsink_timer_handler(struct rtimer *t, void *ptr) {
   if (offs + CRYSTAL_INIT_GUARD + OSC_STAB_TIME + GLOSSY_PRE_TIME > CRYSTAL_PERIOD) {
     // We are that late so the next epoch started
     // (for sure this will not work with period of 2s)
-    epoch ++;
+    CRYSTAL_INC_EPOCH(epoch);
+    if (epoch >= N_FULL_EPOCHS)
+      bs_done = CRYSTAL_BS_DONE_FLAG; // ended the full-epoch bootstrap
+
     corrected_ref_time += CRYSTAL_PERIOD;
     if (offs > CRYSTAL_PERIOD) // safe to subtract 
       offs -= CRYSTAL_PERIOD;
@@ -669,16 +634,16 @@ char nonsink_timer_handler(struct rtimer *t, void *ptr) {
       PT_YIELD(&pt);
 
       // -- Phase S (non-root) --------------------------------------------------------- S (non-root) ---
-      epoch ++;
+      CRYSTAL_INC_EPOCH(epoch);
+      if (epoch >= N_FULL_EPOCHS)
+        bs_done = CRYSTAL_BS_DONE_FLAG; // ended the full-epoch bootstrap
 
       channel = get_channel_epoch(epoch);
 
       glossy_start(&glossy_S, (uint8_t *)crystal_sync, CRYSTAL_SYNC_LEN,
           GLOSSY_RECEIVER, channel, GLOSSY_SYNC, N_TX_S,
           0, // don't stop on sync
-          CRYSTAL_TYPE_SYNC, 
-          0, // don't ignore type
-          t_phase_start, t_phase_stop, timer_handler, t, ptr);
+          CRYSTAL_TYPE_SYNC, t_phase_start, t_phase_stop, timer_handler, t, ptr);
 
       PT_YIELD(&pt);
       glossy_stop();
@@ -697,7 +662,7 @@ char nonsink_timer_handler(struct rtimer *t, void *ptr) {
           && recvlen_s  == CRYSTAL_SYNC_LEN);
 
       if (rx_count_s > 0 && correct_packet) {
-        epoch = crystal_sync->epoch;
+        //epoch = crystal_sync->epoch;
         hopcount = get_relay_cnt();
       }
       if (IS_SYNCED() && rx_count_s > 0
@@ -740,188 +705,187 @@ char nonsink_timer_handler(struct rtimer *t, void *ptr) {
     n_ta_tx = 0;
     n_all_acks = 0;
     sleep_order = 0;
-    synced_with_ack = 0;
 
-    while (1) { /* TA loop */
-// -- Phase T (non-root) --------------------------------------------------------- T (non-root) ---
-      static int guard;
-      static uint16_t have_packet;
-      static int i_tx;
-      log_recv_err = 0;
-      log_recv_src = 0;
-      correct_packet = 0;
-      have_packet = app_pre_T();
-      i_tx = (have_packet && 
-          (sync_missed < N_SILENT_EPOCHS_TO_STOP_SENDING || n_noack_epochs < N_SILENT_EPOCHS_TO_STOP_SENDING));
-      // TODO: instead of just suppressing tx when out of sync it's better to scan for ACKs or Sync beacons...
-
-      if (i_tx) {
-        n_ta_tx ++;
-        // no guards if I transmit
-        guard = 0;
-      }
-      else {
-        // guards for receiving
-        guard = (sync_missed && !synced_with_ack)?CRYSTAL_SHORT_GUARD_NOSYNC:CRYSTAL_SHORT_GUARD;
-      }
-      t_phase_start = corrected_ref_time + PHASE_T_OFFS(n_ta) - CRYSTAL_REF_SHIFT - guard;
-      t_phase_stop = t_phase_start + DUR_T + guard;
-
-      //choice of the channel for each T-A slot
-      channel = get_channel_epoch_ta(epoch, n_ta);
-      
-      glossy_start(&glossy_T, (uint8_t *)crystal_data, CRYSTAL_DATA_LEN, 
-          i_tx, channel, GLOSSY_NO_SYNC, N_TX_T,
-          0, // don't stop on sync
-          CRYSTAL_TYPE_DATA, 
-          0, // don't ignore type
-          t_phase_start, t_phase_stop, timer_handler, t, ptr);
+    if (1/*epoch >= START_EPOCH*/) {
+      synced_with_ack = 0;
 
-      PT_YIELD(&pt);
-      glossy_stop();
-      ton_t += get_rtx_on();
-      UPDATE_TF(tf_t, n_short_t, i_tx, N_TX_T);
-      
-      if (!i_tx) { 
-        if (get_rx_cnt()) { // received data
-          log_recv_type = get_app_header();
-          log_recv_length = get_data_len();
-          correct_packet = (log_recv_length == CRYSTAL_DATA_LEN && log_recv_type == CRYSTAL_TYPE_DATA);
-          log_recv_err = correct_packet?0:CRYSTAL_BAD_DATA;
-          n_empty_ts = 0;
+      while (1) { /* TA loop */
+// -- Phase T (non-root) --------------------------------------------------------- T (non-root) ---
+        static int guard;
+        static uint16_t have_packet;
+        static int i_tx;
+        log_recv_err = 0;
+        log_recv_src = 0;
+        correct_packet = 0;
+        have_packet = app_pre_T();
+        i_tx = (have_packet && 
+            (sync_missed < N_SILENT_EPOCHS_TO_STOP_SENDING || n_noack_epochs < N_SILENT_EPOCHS_TO_STOP_SENDING));
+        // TODO: instead of just suppressing tx when out of sync it's better to scan for ACKs or Sync beacons...
+
+        if (i_tx) {
+          n_ta_tx ++;
+          // no guards if I transmit
+          guard = 0;
         }
-        else if (is_corrupted()) {
-          log_recv_type = 0;
-          log_recv_seqn = 0;
-          log_recv_length = 0;
-          log_recv_err = CRYSTAL_BAD_CRC;
-          //n_empty_ts = 0; // keep it as it is to give another chance but not too many chances
-        } 
-        else { // TODO: should we check for the high noise also here?
-          log_recv_type = 0;
-          log_recv_seqn = 0;
-          log_recv_length = 0;
-          log_recv_err = CRYSTAL_SILENCE;
-          n_empty_ts ++;
+        else {
+          // guards for receiving
+          guard = (sync_missed && !synced_with_ack)?CRYSTAL_SHORT_GUARD_NOSYNC:CRYSTAL_SHORT_GUARD;
         }
-        cca_busy_cnt = get_cca_busy_cnt();
-      }
+        t_phase_start = corrected_ref_time + PHASE_T_OFFS(n_ta) - CRYSTAL_REF_SHIFT - guard;
+        t_phase_stop = t_phase_start + DUR_T + guard;
 
-      app_between_TA(correct_packet);
+        //choice of the channel for each T-A slot
+        channel = get_channel_epoch_ta(epoch, n_ta);
+        
+        glossy_start(&glossy_T, (uint8_t *)crystal_data, CRYSTAL_DATA_LEN, 
+            i_tx, channel, GLOSSY_NO_SYNC, N_TX_T,
+            0, // don't stop on sync
+            CRYSTAL_TYPE_DATA, t_phase_start, t_phase_stop, timer_handler, t, ptr);
+
+        PT_YIELD(&pt);
+        glossy_stop();
+        ton_t += get_rtx_on();
+        UPDATE_TF(tf_t, n_short_t, i_tx, N_TX_T);
+        
+        if (!i_tx) { 
+          if (get_rx_cnt()) { // received data
+            log_recv_type = get_app_header();
+            log_recv_length = get_data_len();
+            correct_packet = (log_recv_length == CRYSTAL_DATA_LEN && log_recv_type == CRYSTAL_TYPE_DATA);
+            log_recv_err = correct_packet?0:CRYSTAL_BAD_DATA;
+            n_empty_ts = 0;
+          }
+          else if (is_corrupted()) {
+            log_recv_type = 0;
+            log_recv_seqn = 0;
+            log_recv_length = 0;
+            log_recv_err = CRYSTAL_BAD_CRC;
+            //n_empty_ts = 0; // keep it as it is to give another chance but not too many chances
+          } 
+          else { // TODO: should we check for the high noise also here?
+            log_recv_type = 0;
+            log_recv_seqn = 0;
+            log_recv_length = 0;
+            log_recv_err = CRYSTAL_SILENCE;
+            n_empty_ts ++;
+          }
+          cca_busy_cnt = get_cca_busy_cnt();
+        }
 
-      BZERO_BUF();
-      
+        app_between_TA(correct_packet);
+
+        BZERO_BUF();
+        
 // -- Phase T end (non-root) ------------------------------------------------- T end (non-root) ---
 
 // -- Phase A (non-root) --------------------------------------------------------- A (non-root) ---
 
-      correct_packet = 0;
-      guard = (sync_missed && !synced_with_ack)?CRYSTAL_SHORT_GUARD_NOSYNC:CRYSTAL_SHORT_GUARD;
-      t_phase_start = corrected_ref_time - guard + PHASE_A_OFFS(n_ta) - CRYSTAL_REF_SHIFT;
-      t_phase_stop = t_phase_start + DUR_A + guard;
-
-      glossy_start(&glossy_A, (uint8_t *)crystal_ack, CRYSTAL_ACK_LEN, 
-          GLOSSY_RECEIVER, channel, CRYSTAL_SYNC_ACKS, N_TX_A,
-          0, // don't stop on sync
-          CRYSTAL_TYPE_ACK, 
-          0, // don't ignore type
-          t_phase_start, t_phase_stop, timer_handler, t, ptr);
-
-      PT_YIELD(&pt);
-      glossy_stop();
-      ton_a += get_rtx_on();
-      UPDATE_TF(tf_a, n_short_a, 0, N_TX_A);
-
-      if (get_rx_cnt()) {
-        if (get_data_len() == CRYSTAL_ACK_LEN 
-            && get_app_header() == CRYSTAL_TYPE_ACK 
-            && CRYSTAL_ACK_CMD_CORRECT(crystal_ack)) {
-          correct_packet = 1;
-          n_noacks = 0;
-          n_bad_acks = 0;
-          n_all_acks ++;
-          // Updating the epoch in case we "skipped" some epochs but got an ACK
-          // We can "skip" epochs if we are too late for the next TA and set the timer to the past
-          epoch = crystal_ack->epoch; 
-
-          #if (CRYSTAL_SYNC_ACKS)
-          // sometimes we get a packet with a corrupted n_ta
-          // (e.g. 234) that's why checking the value
-          // sometimes also the ref time is reported incorrectly, so have to check
-          if (IS_SYNCED() && crystal_ack->n_ta == n_ta
-                  && correct_ack_skew(N_TA_TO_REF(get_t_ref_l(), crystal_ack->n_ta))
-              ) {
+        correct_packet = 0;
+        guard = (sync_missed && !synced_with_ack)?CRYSTAL_SHORT_GUARD_NOSYNC:CRYSTAL_SHORT_GUARD;
+        t_phase_start = corrected_ref_time - guard + PHASE_A_OFFS(n_ta) - CRYSTAL_REF_SHIFT;
+        t_phase_stop = t_phase_start + DUR_A + guard;
+
+        glossy_start(&glossy_A, (uint8_t *)crystal_ack, CRYSTAL_ACK_LEN, 
+            GLOSSY_RECEIVER, channel, CRYSTAL_SYNC_ACKS, N_TX_A,
+            0, // don't stop on sync
+            CRYSTAL_TYPE_ACK, t_phase_start, t_phase_stop, timer_handler, t, ptr);
+
+        PT_YIELD(&pt);
+        glossy_stop();
+        ton_a += get_rtx_on();
+        UPDATE_TF(tf_a, n_short_a, 0, N_TX_A);
+
+        if (get_rx_cnt()) {
+          if (get_data_len() == CRYSTAL_ACK_LEN 
+              && get_app_header() == CRYSTAL_TYPE_ACK 
+              && CRYSTAL_ACK_CMD_CORRECT(crystal_ack)) {
+            correct_packet = 1;
+            n_noacks = 0;
+            n_bad_acks = 0;
+            n_all_acks ++;
+            // Updating the epoch in case we "skipped" some epochs but got an ACK
+            // We can "skip" epochs if we are too late for the next TA and set the timer to the past
+            //epoch = crystal_ack->epoch; 
+
+            #if (CRYSTAL_SYNC_ACKS)
+            // sometimes we get a packet with a corrupted n_ta
+            // (e.g. 234) that's why checking the value
+            // sometimes also the ref time is reported incorrectly, so have to check
+            if (IS_SYNCED() && crystal_ack->n_ta == n_ta
+                    && correct_ack_skew(N_TA_TO_REF(get_t_ref_l(), crystal_ack->n_ta))
+                ) {
+              
+              corrected_ref_time = N_TA_TO_REF(get_t_ref_l(), crystal_ack->n_ta);
+              synced_with_ack ++;
+              n_noack_epochs = 0; // it's important to reset it here to reenable TX right away (if it was suppressed)
+            }
+            #endif
             
-            corrected_ref_time = N_TA_TO_REF(get_t_ref_l(), crystal_ack->n_ta);
-            synced_with_ack ++;
-            n_noack_epochs = 0; // it's important to reset it here to reenable TX right away (if it was suppressed)
+            if (CRYSTAL_ACK_SLEEP(crystal_ack)) {
+              sleep_order = 1;
+            }
           }
-          #endif
-          
-          if (CRYSTAL_ACK_SLEEP(crystal_ack)) {
-            sleep_order = 1;
+          else {
+            // received something but not an ack (we might be out of sync)
+            // n_noacks ++; // keep it as it is to give another chance but not too many chances
+            n_bad_acks ++;
           }
+
+          // logging info about bad packets
+          if (get_app_header() != CRYSTAL_TYPE_ACK)
+            n_badtype_a ++;
+          if (get_data_len() != CRYSTAL_ACK_LEN)
+            n_badlen_a ++;
+
+          n_high_noise = 0;
         }
-        else {
-          // received something but not an ack (we might be out of sync)
+        else if (is_corrupted()) { // bad CRC
           // n_noacks ++; // keep it as it is to give another chance but not too many chances
           n_bad_acks ++;
+          n_badcrc_a ++;
+          n_high_noise = 0;
         }
-
-        // logging info about bad packets
-        if (get_app_header() != CRYSTAL_TYPE_ACK)
-          n_badtype_a ++;
-        if (get_data_len() != CRYSTAL_ACK_LEN)
-          n_badlen_a ++;
-
-        n_high_noise = 0;
-      }
-      else if (is_corrupted()) { // bad CRC
-        // n_noacks ++; // keep it as it is to give another chance but not too many chances
-        n_bad_acks ++;
-        n_badcrc_a ++;
-        n_high_noise = 0;
-      }
-      else { // not received anything
-        if (CRYSTAL_MAX_NOISY_AS == 0)
-          n_noacks ++; // no "noise detection"
-        else if (get_cca_busy_cnt() > CCA_COUNTER_THRESHOLD) {
-          n_high_noise ++;
-          if (n_high_noise > CRYSTAL_MAX_NOISY_AS)
+        else { // not received anything
+          if (CRYSTAL_MAX_NOISY_AS == 0)
+            n_noacks ++; // no "noise detection"
+          else if (get_cca_busy_cnt() > CCA_COUNTER_THRESHOLD) {
+            n_high_noise ++;
+            if (n_high_noise > CRYSTAL_MAX_NOISY_AS)
+              n_noacks ++;
+          }
+          else {
             n_noacks ++;
+            n_high_noise = 0;
+          }
         }
-        else {
-          n_noacks ++;
-          n_high_noise = 0;
-        }
-      }
 
-      app_post_A(correct_packet);
+        app_post_A(correct_packet);
 
-      if (i_tx)
-        log_ta_tx();
-      else
-        log_ta_rx();
+        if (i_tx)
+          log_ta_tx();
+        else
+          log_ta_rx();
 
-      BZERO_BUF();
+        BZERO_BUF();
 // -- Phase A end (non-root) ------------------------------------------------- A end (non-root) ---
-      n_ta ++;
-
-      // shall we stop?
-      if (sleep_order || (n_ta >= CRYSTAL_MAX_TAS) || // always stop when ordered or max is reached
-          (epoch >= N_FULL_EPOCHS && (
-              (  have_packet  && (n_noacks >= CRYSTAL_MAX_MISSING_ACKS)) ||
-              ((!have_packet) && (n_noacks >= CRYSTAL_MAX_SILENT_TAS) && n_empty_ts >= CRYSTAL_MAX_SILENT_TAS)
+        n_ta ++;
+
+        // shall we stop?
+        if (sleep_order || (n_ta >= CRYSTAL_MAX_TAS) || // always stop when ordered or max is reached
+            (bs_done && (
+                (  have_packet  && (n_noacks >= CRYSTAL_MAX_MISSING_ACKS)) ||
+                ((!have_packet) && (n_noacks >= CRYSTAL_MAX_SILENT_TAS) && n_empty_ts >= CRYSTAL_MAX_SILENT_TAS)
+              )
             )
-          )
-        ) {
-        
-        break; // Stop the TA chain
-      }
-    } /* End of TA loop */
+          ) {
+          
+          break; // Stop the TA chain
+        }
+      } /* End of TA loop */
 
-    if (!synced_with_ack) {
-      n_noack_epochs ++;
+      if (!synced_with_ack) {
+        n_noack_epochs ++;
+      }
     }
     cc2420_oscoff(); // deep sleep
     app_epoch_end();
@@ -975,6 +939,14 @@ PROCESS_THREAD(crystal_test, ev, data)
 {
   PROCESS_BEGIN();
 
+  // put external flash memory into deep power-down mode
+  SPI_FLASH_ENABLE();       // set chip select low (P4.4)
+  FASTSPI_TX(0xb9);         // send deep power-down command
+  SPI_WAITFORTx_ENDED();    // wait for transmission to end
+  SPI_FLASH_DISABLE();      // set chip select high  
+
+  random_init(node_id);
+
   app_init();
 
   if (IS_SINK())
@@ -1011,6 +983,7 @@ PROCESS_THREAD(crystal_print_stats_process, ev, data)
   static int first_time = 1;
   static unsigned long avg_radio_on;
   static uint16_t scan_channel;
+  static uint16_t last_epoch, epoch_shift;
   PROCESS_BEGIN();
 
   while(1) {
@@ -1021,14 +994,19 @@ PROCESS_THREAD(crystal_print_stats_process, ev, data)
     noise = cc2420_rssi();
     cc2420_oscoff();
 
+    if (epoch<last_epoch) { // overflow
+      epoch_shift += 128;
+    }
+    print_epoch = epoch + epoch_shift;
+    last_epoch = epoch;
     if (!IS_SINK()) {
-      printf("S %u:%u %u %u:%u %d %u\n", epoch, n_ta_tx, n_all_acks, synced_with_ack, sync_missed, period_skew, hopcount);
-      printf("P %u:%u %u %u:%u %u %u %d:%ld\n", epoch, recvsrc_s, recvtype_s, recvlen_s, n_badtype_a, n_badlen_a, n_badcrc_a, ack_skew_err, end_of_s_time);
+      PRINTF("S %u:%u %u %u:%u %d %u\n", print_epoch, n_ta_tx, n_all_acks, synced_with_ack, sync_missed, period_skew, hopcount);
+      PRINTF("P %u:%u %u %u:%u %u %u %d:%ld\n", print_epoch, recvsrc_s, recvtype_s, recvlen_s, n_badtype_a, n_badlen_a, n_badcrc_a, ack_skew_err, end_of_s_time);
     }
     
-    printf("R %u:%u %u:%d %u:%u %u %u\n", epoch, n_ta, n_rec_rx, noise, scan_channel, tx_count_s, rx_count_s, cca_busy_cnt);
+    PRINTF("R %u:%u %u:%d %u:%u %u %u\n", print_epoch, n_ta, n_rec_rx, noise, scan_channel, tx_count_s, rx_count_s, cca_busy_cnt);
     for (i=0; i<n_rec_rx; i++) {
-      printf("T %u:%u %u %u %u %u %u %u %u\n", epoch, i,
+      PRINTF("T %u:%u %u %u %u %u %u %u %u\n", print_epoch, i,
         recv_t[i].type,
         recv_t[i].src,
         recv_t[i].seqn,
@@ -1038,7 +1016,7 @@ PROCESS_THREAD(crystal_print_stats_process, ev, data)
         recv_t[i].err_code);
     }
     for (i=0; i<n_rec_tx; i++) {
-      printf("Q %u:%u %u %u %u %u\n", epoch, i,
+      PRINTF("Q %u:%u %u %u %u %u\n", print_epoch, i,
         send_t[i].seqn,
         send_t[i].n_ta,
         send_t[i].rx_count,
@@ -1046,7 +1024,7 @@ PROCESS_THREAD(crystal_print_stats_process, ev, data)
     }
 
     app_print_logs();
-    /*printf("D %u:%u %lu %u:%u %lu %u\n", epoch,
+    /*printf("D %u:%u %lu %u:%u %lu %u\n", print_epoch,
         glossy_S.T_slot_h, glossy_S.T_slot_h_sum, glossy_S.win_cnt,
         glossy_A.T_slot_h, glossy_A.T_slot_h_sum, glossy_A.win_cnt
         );*/
@@ -1058,9 +1036,9 @@ PROCESS_THREAD(crystal_print_stats_process, ev, data)
          * 1e6 /
         (energest_type_time(ENERGEST_TYPE_CPU) + energest_type_time(ENERGEST_TYPE_LPM));
       // Print information about average radio-on time per second.
-      printf("E %u:%lu.%03lu:%u %u %u\n", epoch,
+      printf("E %u:%lu.%03lu:%u %u %u\n", print_epoch,
           avg_radio_on / 1000, avg_radio_on % 1000, ton_s, ton_t, ton_a);
-      printf("F %u:%u %u %u:%u %u %u\n", epoch,
+      printf("F %u:%u %u %u:%u %u %u\n", print_epoch,
           tf_s, tf_t, tf_a, n_short_s, n_short_t, n_short_a);
     }
     // Initialize Energest values.
diff --git a/apps/crystal/crystal.h b/apps/crystal/crystal.h
index 86d5f41..6540232 100644
--- a/apps/crystal/crystal.h
+++ b/apps/crystal/crystal.h
@@ -73,7 +73,8 @@
  * Guard-time when clock skew is not yet estimated
  */
 //#define CRYSTAL_INIT_GUARD  (RTIMER_SECOND / 50)     //  20 ms, IPSN'18
-#define CRYSTAL_INIT_GUARD  (RTIMER_SECOND / 100)    //  10 ms
+//#define CRYSTAL_INIT_GUARD  (RTIMER_SECOND / 100)    //  10 ms
+#define CRYSTAL_INIT_GUARD  (RTIMER_SECOND / 66)    //  15 ms
 
 /**
  * Duration during bootstrapping at receivers.
@@ -83,8 +84,15 @@
 typedef uint8_t crystal_addr_t; // IPSN'18
 //typedef uint16_t crystal_addr_t;
 
-//typedef uint8_t crystal_epoch_t; // NOT SUPPORTED !
-typedef uint16_t crystal_epoch_t; // IPSN'18
+//typedef uint16_t crystal_epoch_t; // IPSN'18
+
+typedef uint8_t crystal_epoch_t; // Needs a wrap-around protection!
+
+#define CRYSTAL_GET_EPOCH(value) ((value) & 0x7f)  // 7 bit for the epoch
+#define CRYSTAL_GET_BS_DONE(value) ((value) & 0x80) // 1 bit bootstrap flag
+#define CRYSTAL_BS_DONE_FLAG 0x80
+#define CRYSTAL_INC_EPOCH(value) (value) = (((value) & 0x80) | (((value) + 1) & 0x7f))
+
 
 
 /**
diff --git a/apps/crystal/mrm.csc b/apps/crystal/mrm.csc
deleted file mode 100644
index 9a7ab1a..0000000
--- a/apps/crystal/mrm.csc
+++ /dev/null
@@ -1,239 +0,0 @@
-<?xml version="1.0" encoding="UTF-8"?>
-<simconf>
-  <project EXPORT="discard">[APPS_DIR]/mrm</project>
-  <project EXPORT="discard">[APPS_DIR]/mspsim</project>
-  <project EXPORT="discard">[APPS_DIR]/avrora</project>
-  <project EXPORT="discard">[APPS_DIR]/serial_socket</project>
-  <project EXPORT="discard">[APPS_DIR]/collect-view</project>
-  <project EXPORT="discard">[APPS_DIR]/powertracker</project>
-  <simulation>
-    <title>glossy</title>
-    <randomseed>123456</randomseed>
-    <motedelay_us>500000</motedelay_us>
-    <radiomedium>
-      org.contikios.mrm.MRM
-      <obstacles />
-    </radiomedium>
-    <events>
-      <logoutput>40000</logoutput>
-    </events>
-    <motetype>
-      org.contikios.cooja.mspmote.SkyMoteType
-      <identifier>sky1</identifier>
-      <description>Sky Mote Type #sky1</description>
-      <firmware EXPORT="copy">[CONFIG_DIR]/crystal.sky</firmware>
-      <moteinterface>org.contikios.cooja.interfaces.Position</moteinterface>
-      <moteinterface>org.contikios.cooja.interfaces.RimeAddress</moteinterface>
-      <moteinterface>org.contikios.cooja.interfaces.IPAddress</moteinterface>
-      <moteinterface>org.contikios.cooja.interfaces.Mote2MoteRelations</moteinterface>
-      <moteinterface>org.contikios.cooja.interfaces.MoteAttributes</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.MspClock</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.MspMoteID</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.SkyButton</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.SkyFlash</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.SkyCoffeeFilesystem</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.Msp802154Radio</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.MspSerial</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.SkyLED</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.MspDebugOutput</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.SkyTemperature</moteinterface>
-    </motetype>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>986.0033756702496</x>
-        <y>-710.5647338881007</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>1</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>687.757640536886</x>
-        <y>-751.1822747858557</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>2</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>380.1718276029684</x>
-        <y>-776.8992070839597</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>3</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>40.91681857780837</x>
-        <y>-769.6347630744639</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>4</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>-245.2752277406714</x>
-        <y>-652.6754318337064</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>5</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>-724.1660649207139</x>
-        <y>-190.7367972985602</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>6</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>-559.3111041374273</x>
-        <y>-448.08648376912004</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>7</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-  </simulation>
-  <plugin>
-    org.contikios.cooja.plugins.SimControl
-    <width>280</width>
-    <z>1</z>
-    <height>160</height>
-    <location_x>8</location_x>
-    <location_y>414</location_y>
-  </plugin>
-  <plugin>
-    org.contikios.cooja.plugins.Visualizer
-    <plugin_config>
-      <moterelations>true</moterelations>
-      <skin>org.contikios.cooja.plugins.skins.IDVisualizerSkin</skin>
-      <skin>org.contikios.cooja.plugins.skins.TrafficVisualizerSkin</skin>
-      <viewport>0.33381136565261255 0.0 0.0 0.33381136565261255 292.6418215515225 308.7533700303805</viewport>
-    </plugin_config>
-    <width>711</width>
-    <z>4</z>
-    <height>399</height>
-    <location_x>1</location_x>
-    <location_y>1</location_y>
-  </plugin>
-  <plugin>
-    org.contikios.cooja.plugins.LogListener
-    <plugin_config>
-      <filter />
-      <formatted_time />
-      <coloring />
-    </plugin_config>
-    <width>497</width>
-    <z>0</z>
-    <height>240</height>
-    <location_x>715</location_x>
-    <location_y>5</location_y>
-  </plugin>
-  <plugin>
-    org.contikios.cooja.plugins.TimeLine
-    <plugin_config>
-      <mote>0</mote>
-      <mote>1</mote>
-      <mote>2</mote>
-      <mote>3</mote>
-      <mote>4</mote>
-      <mote>5</mote>
-      <mote>6</mote>
-      <showRadioRXTX />
-      <showRadioChannels />
-      <showLEDs />
-      <zoomfactor>50000.0</zoomfactor>
-    </plugin_config>
-    <width>1276</width>
-    <z>2</z>
-    <height>230</height>
-    <location_x>3</location_x>
-    <location_y>604</location_y>
-  </plugin>
-  <plugin>
-    org.contikios.cooja.plugins.RadioLogger
-    <plugin_config>
-      <split>150</split>
-      <formatted_time />
-      <showdups>false</showdups>
-      <hidenodests>false</hidenodests>
-    </plugin_config>
-    <width>500</width>
-    <z>3</z>
-    <height>300</height>
-    <location_x>718</location_x>
-    <location_y>252</location_y>
-  </plugin>
-</simconf>
-
diff --git a/apps/crystal/mrm_bad_links.csc b/apps/crystal/mrm_bad_links.csc
deleted file mode 100644
index cc37f72..0000000
--- a/apps/crystal/mrm_bad_links.csc
+++ /dev/null
@@ -1,239 +0,0 @@
-<?xml version="1.0" encoding="UTF-8"?>
-<simconf>
-  <project EXPORT="discard">[APPS_DIR]/mrm</project>
-  <project EXPORT="discard">[APPS_DIR]/mspsim</project>
-  <project EXPORT="discard">[APPS_DIR]/avrora</project>
-  <project EXPORT="discard">[APPS_DIR]/serial_socket</project>
-  <project EXPORT="discard">[APPS_DIR]/collect-view</project>
-  <project EXPORT="discard">[APPS_DIR]/powertracker</project>
-  <simulation>
-    <title>glossy</title>
-    <randomseed>123465</randomseed>
-    <motedelay_us>500000</motedelay_us>
-    <radiomedium>
-      org.contikios.mrm.MRM
-      <obstacles />
-    </radiomedium>
-    <events>
-      <logoutput>40000</logoutput>
-    </events>
-    <motetype>
-      org.contikios.cooja.mspmote.SkyMoteType
-      <identifier>sky1</identifier>
-      <description>Sky Mote Type #sky1</description>
-      <firmware EXPORT="copy">[CONFIG_DIR]/crystal.sky</firmware>
-      <moteinterface>org.contikios.cooja.interfaces.Position</moteinterface>
-      <moteinterface>org.contikios.cooja.interfaces.RimeAddress</moteinterface>
-      <moteinterface>org.contikios.cooja.interfaces.IPAddress</moteinterface>
-      <moteinterface>org.contikios.cooja.interfaces.Mote2MoteRelations</moteinterface>
-      <moteinterface>org.contikios.cooja.interfaces.MoteAttributes</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.MspClock</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.MspMoteID</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.SkyButton</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.SkyFlash</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.SkyCoffeeFilesystem</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.Msp802154Radio</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.MspSerial</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.SkyLED</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.MspDebugOutput</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.SkyTemperature</moteinterface>
-    </motetype>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>1854.6041179881163</x>
-        <y>-648.7573716382751</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>1</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>1464.2440836909564</x>
-        <y>-943.7509126880651</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>2</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>957.8777413095968</x>
-        <y>-1130.9770251622158</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>3</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>463.3254436536227</x>
-        <y>-1204.467171240743</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>4</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>-40.28280674799673</x>
-        <y>-1155.838646997544</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>5</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>-494.3260777471088</x>
-        <y>-1066.6135051763517</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>6</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>-770.5154166753343</x>
-        <y>-938.8259158424928</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>7</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-  </simulation>
-  <plugin>
-    org.contikios.cooja.plugins.SimControl
-    <width>280</width>
-    <z>0</z>
-    <height>160</height>
-    <location_x>8</location_x>
-    <location_y>414</location_y>
-  </plugin>
-  <plugin>
-    org.contikios.cooja.plugins.Visualizer
-    <plugin_config>
-      <moterelations>true</moterelations>
-      <skin>org.contikios.cooja.plugins.skins.IDVisualizerSkin</skin>
-      <skin>org.contikios.cooja.plugins.skins.TrafficVisualizerSkin</skin>
-      <viewport>0.16098156136796518 0.0 0.0 0.16098156136796518 343.1343661031647 215.52380884952757</viewport>
-    </plugin_config>
-    <width>711</width>
-    <z>1</z>
-    <height>399</height>
-    <location_x>1</location_x>
-    <location_y>1</location_y>
-  </plugin>
-  <plugin>
-    org.contikios.cooja.plugins.LogListener
-    <plugin_config>
-      <filter />
-      <formatted_time />
-      <coloring />
-    </plugin_config>
-    <width>497</width>
-    <z>3</z>
-    <height>240</height>
-    <location_x>715</location_x>
-    <location_y>5</location_y>
-  </plugin>
-  <plugin>
-    org.contikios.cooja.plugins.TimeLine
-    <plugin_config>
-      <mote>0</mote>
-      <mote>1</mote>
-      <mote>2</mote>
-      <mote>3</mote>
-      <mote>4</mote>
-      <mote>5</mote>
-      <mote>6</mote>
-      <showRadioRXTX />
-      <showRadioChannels />
-      <showLEDs />
-      <zoomfactor>10000.0</zoomfactor>
-    </plugin_config>
-    <width>1276</width>
-    <z>2</z>
-    <height>230</height>
-    <location_x>3</location_x>
-    <location_y>604</location_y>
-  </plugin>
-  <plugin>
-    org.contikios.cooja.plugins.RadioLogger
-    <plugin_config>
-      <split>150</split>
-      <formatted_time />
-      <showdups>false</showdups>
-      <hidenodests>false</hidenodests>
-    </plugin_config>
-    <width>500</width>
-    <z>4</z>
-    <height>300</height>
-    <location_x>718</location_x>
-    <location_y>252</location_y>
-  </plugin>
-</simconf>
-
diff --git a/apps/crystal/mrm_big.csc b/apps/crystal/mrm_big.csc
deleted file mode 100644
index 50f91e0..0000000
--- a/apps/crystal/mrm_big.csc
+++ /dev/null
@@ -1,429 +0,0 @@
-<?xml version="1.0" encoding="UTF-8"?>
-<simconf>
-  <project EXPORT="discard">[APPS_DIR]/mrm</project>
-  <project EXPORT="discard">[APPS_DIR]/mspsim</project>
-  <project EXPORT="discard">[APPS_DIR]/avrora</project>
-  <project EXPORT="discard">[APPS_DIR]/serial_socket</project>
-  <project EXPORT="discard">[APPS_DIR]/collect-view</project>
-  <project EXPORT="discard">[APPS_DIR]/powertracker</project>
-  <simulation>
-    <title>glossy</title>
-    <randomseed>123456</randomseed>
-    <motedelay_us>10000000</motedelay_us>
-    <radiomedium>
-      org.contikios.mrm.MRM
-      <obstacles />
-    </radiomedium>
-    <events>
-      <logoutput>40000</logoutput>
-    </events>
-    <motetype>
-      org.contikios.cooja.mspmote.SkyMoteType
-      <identifier>sky1</identifier>
-      <description>Sky Mote Type #sky1</description>
-      <firmware EXPORT="copy">[CONFIG_DIR]/crystal.sky</firmware>
-      <moteinterface>org.contikios.cooja.interfaces.Position</moteinterface>
-      <moteinterface>org.contikios.cooja.interfaces.RimeAddress</moteinterface>
-      <moteinterface>org.contikios.cooja.interfaces.IPAddress</moteinterface>
-      <moteinterface>org.contikios.cooja.interfaces.Mote2MoteRelations</moteinterface>
-      <moteinterface>org.contikios.cooja.interfaces.MoteAttributes</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.MspClock</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.MspMoteID</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.SkyButton</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.SkyFlash</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.SkyCoffeeFilesystem</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.Msp802154Radio</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.MspSerial</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.SkyLED</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.MspDebugOutput</moteinterface>
-      <moteinterface>org.contikios.cooja.mspmote.interfaces.SkyTemperature</moteinterface>
-    </motetype>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>236.911442477518</x>
-        <y>-661.1740569742942</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>1</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>687.757640536886</x>
-        <y>-751.1822747858557</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>2</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>380.1718276029684</x>
-        <y>-776.8992070839597</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>3</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>40.91681857780837</x>
-        <y>-769.6347630744639</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>4</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>-245.2752277406714</x>
-        <y>-652.6754318337064</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>5</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>-724.1660649207139</x>
-        <y>-190.7367972985602</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>6</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>-559.3111041374273</x>
-        <y>-448.08648376912004</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>7</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>-266.6738601476518</x>
-        <y>-337.87426887245044</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>8</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>726.6174328449696</x>
-        <y>-613.4944319488488</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>9</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>398.6862891289325</x>
-        <y>-643.7748991594656</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>10</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>-351.6926074039511</x>
-        <y>-511.38709007409295</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>11</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>-83.75067896284749</x>
-        <y>-582.9489200822183</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>12</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>10.0053011728684</x>
-        <y>-465.8685351299006</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>13</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>930.4691539697893</x>
-        <y>-563.8707319102691</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>14</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>-522.8476803982536</x>
-        <y>-233.14802163653775</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>15</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>298.9412487487702</x>
-        <y>-526.9822969241382</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>16</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-    <mote>
-      <breakpoints />
-      <interface_config>
-        org.contikios.cooja.interfaces.Position
-        <x>912.5273130503211</x>
-        <y>-707.26205821919</y>
-        <z>0.0</z>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspClock
-        <deviation>1.0</deviation>
-      </interface_config>
-      <interface_config>
-        org.contikios.cooja.mspmote.interfaces.MspMoteID
-        <id>17</id>
-      </interface_config>
-      <motetype_identifier>sky1</motetype_identifier>
-    </mote>
-  </simulation>
-  <plugin>
-    org.contikios.cooja.plugins.SimControl
-    <width>280</width>
-    <z>0</z>
-    <height>160</height>
-    <location_x>422</location_x>
-    <location_y>207</location_y>
-  </plugin>
-  <plugin>
-    org.contikios.cooja.plugins.Visualizer
-    <plugin_config>
-      <moterelations>true</moterelations>
-      <skin>org.contikios.cooja.plugins.skins.IDVisualizerSkin</skin>
-      <skin>org.contikios.cooja.plugins.skins.TrafficVisualizerSkin</skin>
-      <viewport>0.36444124933562816 0.0 0.0 0.36444124933562816 327.28784167387903 324.3159358193554</viewport>
-    </plugin_config>
-    <width>711</width>
-    <z>3</z>
-    <height>339</height>
-    <location_x>1</location_x>
-    <location_y>1</location_y>
-  </plugin>
-  <plugin>
-    org.contikios.cooja.plugins.LogListener
-    <plugin_config>
-      <filter />
-      <formatted_time />
-      <coloring />
-    </plugin_config>
-    <width>497</width>
-    <z>4</z>
-    <height>240</height>
-    <location_x>715</location_x>
-    <location_y>5</location_y>
-  </plugin>
-  <plugin>
-    org.contikios.cooja.plugins.TimeLine
-    <plugin_config>
-      <mote>0</mote>
-      <mote>1</mote>
-      <mote>2</mote>
-      <mote>3</mote>
-      <mote>4</mote>
-      <mote>5</mote>
-      <mote>6</mote>
-      <mote>7</mote>
-      <mote>8</mote>
-      <mote>9</mote>
-      <mote>10</mote>
-      <mote>11</mote>
-      <mote>12</mote>
-      <mote>13</mote>
-      <mote>14</mote>
-      <mote>15</mote>
-      <mote>16</mote>
-      <showRadioRXTX />
-      <showRadioChannels />
-      <showLEDs />
-      <zoomfactor>50000.0</zoomfactor>
-    </plugin_config>
-    <width>1276</width>
-    <z>1</z>
-    <height>423</height>
-    <location_x>15</location_x>
-    <location_y>361</location_y>
-  </plugin>
-  <plugin>
-    org.contikios.cooja.plugins.RadioLogger
-    <plugin_config>
-      <split>150</split>
-      <formatted_time />
-      <showdups>false</showdups>
-      <hidenodests>false</hidenodests>
-    </plugin_config>
-    <width>500</width>
-    <z>2</z>
-    <height>300</height>
-    <location_x>718</location_x>
-    <location_y>233</location_y>
-  </plugin>
-</simconf>
-
diff --git a/core/dev/glossy.c b/core/dev/glossy.c
index 45dfd14..b6d476e 100644
--- a/core/dev/glossy.c
+++ b/core/dev/glossy.c
@@ -28,8 +28,13 @@
  *
  * Author: Federico Ferrari <ferrari@tik.ee.ethz.ch>
  *
- * Contributor: Timofei Istomin <tim.ist@gmail.com>
- *
+ */
+
+/**
+ * \file
+ *         Glossy core, source file.
+ * \author
+ *         Federico Ferrari <ferrari@tik.ee.ethz.ch>
  */
 
 #include "glossy.h"
@@ -51,7 +56,6 @@ static rtimer_callback_t cb;
 static struct rtimer *rtimer;
 static void *ptr;
 static unsigned short ie1, ie2, p1ie, p2ie, tbiv;
-static unsigned short glossy_seqn;
 
 static rtimer_clock_t T_slot_h, T_rx_h, T_w_rt_h, T_tx_h, T_w_tr_h, t_ref_l, T_offset_h, t_first_rx_l;
 #if GLOSSY_SYNC_WINDOW
@@ -59,15 +63,14 @@ static unsigned long T_slot_h_sum;
 static uint8_t win_cnt;
 #endif /* GLOSSY_SYNC_WINDOW */
 static uint8_t relay_cnt, t_ref_l_updated;
-static uint8_t stop_on_sync, ignore_type;
+static uint8_t stop_on_sync;
 
 static struct glossy *glossy_object;
 static unsigned long rtx_when_started;
 static uint16_t cca_last_check, cca_busy_cnt;
 static uint16_t volatile cca_counting;
 static rtimer_clock_t t_start_l;
-static uint8_t channel, app_header, rx_data_len, rx_bad_crc;
-static uint8_t expected_header;
+static uint8_t channel, hdr_and_sync_bit, rx_data_len, rx_bad_crc;
 
 /* --------------------------- Radio functions ---------------------- */
 static inline void radio_flush_tx(void) {
@@ -229,7 +232,7 @@ timerb1_interrupt(void)
                 // set the packet length field to the appropriate value
                 GLOSSY_LEN_FIELD = packet_len_tmp;
                 // set the header field
-                GLOSSY_HEADER_FIELD = expected_header;
+                GLOSSY_HEADER_FIELD = GLOSSY_HEADER | hdr_and_sync_bit;
                 if (sync) {
                   GLOSSY_RELAY_CNT_FIELD = n_timeouts * GLOSSY_INITIATOR_TIMEOUT;
                 }
@@ -447,7 +450,7 @@ void glossy_start(struct glossy *glossy_,
     uint8_t *data_, uint8_t data_len_, uint8_t initiator_,
     uint8_t channel_,
     uint8_t sync_, uint8_t tx_max_, uint8_t stop_on_sync_,
-    uint8_t header_, uint8_t ignore_type_,
+    uint8_t header_,
     rtimer_clock_t t_start_, rtimer_clock_t t_stop_, rtimer_callback_t cb_,
     struct rtimer *rtimer_, void *ptr_) {
   // copy function arguments to the respective Glossy variables
@@ -463,13 +466,14 @@ void glossy_start(struct glossy *glossy_,
   sync = sync_ != 0;
   stop_on_sync = stop_on_sync_;
   tx_max = tx_max_;
+  hdr_and_sync_bit = initiator ? (header_ & GLOSSY_APP_HEADER_MASK) : 0; // only set for the initiator
+  if (sync)
+    hdr_and_sync_bit |= GLOSSY_HEADER_SYNC_BIT;
   t_stop = t_stop_;
   t_start_l = t_start_;
   cb = cb_;
   rtimer = rtimer_;
   ptr = ptr_;
-  ignore_type = ignore_type_;
-  app_header = (header_ & 0x0f) << 4;
 
   // initialize Glossy variables
   tx_cnt = 0;
@@ -487,6 +491,8 @@ void glossy_start(struct glossy *glossy_,
     packet_len = packet_len_tmp;
     // set the packet length field to the appropriate value
     GLOSSY_LEN_FIELD = packet_len_tmp;
+    // set the header field
+    GLOSSY_HEADER_FIELD = GLOSSY_HEADER | hdr_and_sync_bit;
   } else {
     // packet length not known yet (only for receivers)
     packet_len = 0;
@@ -494,14 +500,6 @@ void glossy_start(struct glossy *glossy_,
   if (initiator) {
     // initiator: copy the application data to the data field
     memcpy(&GLOSSY_DATA_FIELD, data, data_len);
-
-    glossy_seqn = (glossy_seqn + 1) & GLOSSY_HEADER_SEQN_MASK;
-
-    // we expect to recv the same header as we send
-    expected_header = app_header | (sync << 3) | glossy_seqn; 
-    // set the header field
-    GLOSSY_HEADER_FIELD = expected_header;
-
     // set Glossy state
     glossy_state = GLOSSY_STATE_RECEIVED;
   } else {
@@ -546,7 +544,7 @@ uint8_t get_data_len(void) {
   return rx_data_len;
 }
 uint8_t get_app_header(void) {
-  return (expected_header & GLOSSY_APP_HEADER_MASK) >> 4;
+  return hdr_and_sync_bit & GLOSSY_APP_HEADER_MASK;
 }
 
 uint8_t get_rx_cnt(void) {
@@ -692,7 +690,7 @@ inline void glossy_begin_rx(void) {
   // read the second byte (i.e., the header field) from the RXFIFO
   FASTSPI_READ_FIFO_BYTE(GLOSSY_HEADER_FIELD);
   // keep receiving only if it has the right header
-  if (!ignore_type && ((GLOSSY_HEADER_FIELD & GLOSSY_APP_HEADER_MASK) != app_header)) {
+  if ((GLOSSY_HEADER_FIELD & GLOSSY_HEADER_MASK) != GLOSSY_HEADER) {
     // packet with a wrong header: abort packet reception
     radio_abort_rx();
 #if GLOSSY_DEBUG
@@ -729,9 +727,19 @@ inline void glossy_end_rx(void) {
   // read the remaining bytes from the RXFIFO
   FASTSPI_READ_FIFO_NO_WAIT(&packet[bytes_read], packet_len_tmp - bytes_read + 1);
   bytes_read = packet_len_tmp + 1;
+#if COOJA
+  if ((GLOSSY_CRC_FIELD & FOOTER1_CRC_OK) && ((GLOSSY_HEADER_FIELD & GLOSSY_HEADER_MASK) == GLOSSY_HEADER)) {
+#else
   if (GLOSSY_CRC_FIELD & FOOTER1_CRC_OK) {
+#endif /* COOJA */
+    hdr_and_sync_bit = GLOSSY_HEADER_FIELD & 0x0f; // 0xf is app header + sync bit
+    recv_sync = (hdr_and_sync_bit & GLOSSY_HEADER_SYNC_BIT) != 0;
     // packet correctly received
-    recv_sync = (GLOSSY_HEADER_FIELD & GLOSSY_HEADER_SYNC_BIT) != 0;
+    if (sync && recv_sync) {
+      // increment relay_cnt field
+      GLOSSY_RELAY_CNT_FIELD++;
+    }
+//#if GLOSSY_STOP_ON_SYNC_MISMATCH
     if (sync != recv_sync) {
       // received sync packet while expecting a non-sync one or vice versa
       // drop and stop
@@ -740,21 +748,16 @@ inline void glossy_end_rx(void) {
       // XXX: note that in this case the packet data is not copied to the
       // application buffer. It is not good but it is ok for Crystal.
     }
-    else {
-      if (tx_cnt == tx_max) {
-        // no more Tx to perform: stop Glossy
-        radio_off();
-        glossy_state = GLOSSY_STATE_OFF;
-      } 
-      else {
-        if (sync) {
-          // increment relay_cnt field
-          GLOSSY_RELAY_CNT_FIELD++;
-        }
-        // write Glossy packet to the TXFIFO
-        radio_write_tx();
-        glossy_state = GLOSSY_STATE_RECEIVED;
-      }
+    else
+//#endif
+    if (tx_cnt == tx_max) {
+      // no more Tx to perform: stop Glossy
+      radio_off();
+      glossy_state = GLOSSY_STATE_OFF;
+    } else {
+      // write Glossy packet to the TXFIFO
+      radio_write_tx();
+      glossy_state = GLOSSY_STATE_RECEIVED;
     }
     if (rx_cnt == 0) {
       // first successful reception:
@@ -763,12 +766,9 @@ inline void glossy_end_rx(void) {
       if (sync && recv_sync) {
         relay_cnt = GLOSSY_RELAY_CNT_FIELD - 1;
       }
-      if (!initiator) {
-        expected_header = GLOSSY_HEADER_FIELD; // in the following messages we expect to see the same header
-      }
     }
     rx_cnt++;
-    if (sync && recv_sync && expected_header == GLOSSY_HEADER_FIELD) {
+    if (sync && recv_sync) {
       estimate_slot_length(t_rx_stop_tmp);
     }
     t_rx_stop = t_rx_stop_tmp;
@@ -803,7 +803,7 @@ inline void glossy_begin_tx(void) {
     memcpy(data, &GLOSSY_DATA_FIELD, data_len);
     rx_data_len = data_len; // to indicate that the received data was actually copied to the data buffer
   }
-  if ((sync) && (T_slot_h) && (!t_ref_l_updated) && (rx_cnt) && expected_header == GLOSSY_HEADER_FIELD) {
+  if ((sync) && (T_slot_h) && (!t_ref_l_updated) && (rx_cnt)) {
     // compute the reference time after the first reception (higher accuracy)
     compute_sync_reference_time();
   }
diff --git a/core/dev/glossy.h b/core/dev/glossy.h
index 0ee47c2..2cb63fe 100644
--- a/core/dev/glossy.h
+++ b/core/dev/glossy.h
@@ -73,9 +73,10 @@
 #define CLOCK_PHI                     (F_CPU / RTIMER_SECOND)
 #endif /* COOJA */
 
-#define GLOSSY_APP_HEADER_MASK        0xf0
+#define GLOSSY_HEADER                 0xa0
+#define GLOSSY_HEADER_MASK            0xf0
+#define GLOSSY_APP_HEADER_MASK        0x07
 #define GLOSSY_HEADER_SYNC_BIT        0x08
-#define GLOSSY_HEADER_SEQN_MASK       0x07
 #define GLOSSY_HEADER_LEN             sizeof(uint8_t)
 #define GLOSSY_RELAY_CNT_LEN          sizeof(uint8_t)
 #define GLOSSY_IS_ON()                (get_state() != GLOSSY_STATE_OFF)
@@ -158,7 +159,6 @@ PROCESS_NAME(glossy_process);
  *                   zero otherwise.
  * \param tx_max_    Maximum number of transmissions (N).
  * \param header_    Application-specific header (value between 0x0 and 0xf).
- * \param header_    Ignore app header of received packets (receive everything)
  * \param t_start_   Time instant at which Glossy must turn on the radio
  *                   (and send the packet if initiator)
  * \param t_stop_    Time instant at which Glossy must stop, in case it is
@@ -171,7 +171,7 @@ PROCESS_NAME(glossy_process);
 void glossy_start(struct glossy *glossy_,
     uint8_t *data_, uint8_t data_len_, uint8_t initiator_, uint8_t channel_,
     uint8_t sync_, uint8_t tx_max_, uint8_t stop_on_sync_,
-    uint8_t header_, uint8_t ignore_type_,
+    uint8_t header_,
     rtimer_clock_t t_start_, rtimer_clock_t t_stop_, rtimer_callback_t cb_,
     struct rtimer *rtimer_, void *ptr_);
 
diff --git a/cpu/msp430/leds-arch.c b/cpu/msp430/leds-arch.c
index 049109c..b797248 100644
--- a/cpu/msp430/leds-arch.c
+++ b/cpu/msp430/leds-arch.c
@@ -63,9 +63,11 @@ leds_arch_get(void)
 void
 leds_arch_set(unsigned char leds)
 {
+#if LEDS_CONF_ON
   LEDS_PxOUT = (LEDS_PxOUT & ~(LEDS_CONF_RED|LEDS_CONF_GREEN|LEDS_CONF_YELLOW))
     | ((leds & LEDS_RED) ? 0 : LEDS_CONF_RED)
     | ((leds & LEDS_GREEN) ? 0 : LEDS_CONF_GREEN)
     | ((leds & LEDS_YELLOW) ? 0 : LEDS_CONF_YELLOW);
+#endif
 }
 /*---------------------------------------------------------------------------*/
diff --git a/cpu/msp430/msp430.c b/cpu/msp430/msp430.c
index 59d0f60..1b5e86f 100644
--- a/cpu/msp430/msp430.c
+++ b/cpu/msp430/msp430.c
@@ -177,6 +177,21 @@ init_ports(void)
   P6OUT = 0;
 #endif
 
+  /* set recommended pin config */
+  //P1OUT = 0;
+  //P1DIR = 0xe0;       // P1.1: UART BSL (input)
+  //P2OUT = 0x30;       // P2.4 and 2.5: output high
+  //P2DIR = 0x7b;       // P2.2: UART BSL (input), P2.8: user_int (button)
+  //P3OUT = 0;
+  //P3DIR = 0xf1;       // P3.0: not connected, P3.1 - 3.3: radio (don't change), P3.4 & 3.5: UART0, P3.6 & 3.7: UART1
+  //P4OUT = 0xfd;       // P4.4 - 4.7: output high (P4.5: V_REG for cc2420)
+  //P4DIR = 0xfd;       // all but P4.1 are outputs
+  //P5OUT = 0xff;
+  //P5DIR = 0xff;       // unconnected pins and LEDs (active low!)
+  //P6OUT = 0;   
+  //P6DIR = 0xcf;       // extension header + light sensors (P6.4 and 6.5)
+  
+
   P1IE = 0;
   P2IE = 0;
 }
diff --git a/platform/sky/Makefile.sky b/platform/sky/Makefile.sky
index 3390a8c..3ee4b98 100644
--- a/platform/sky/Makefile.sky
+++ b/platform/sky/Makefile.sky
@@ -2,7 +2,7 @@
 
 
 ARCH=glossy.c msp430.c leds.c watchdog.c spi.c \
-     xmem.c cc2420.c node-id.c uart1.c ds2411.c
+     xmem.c cc2420.c node-id.c uart1.c ds2411.c random.c
 
 CONTIKI_TARGET_DIRS = . dev apps net
 ifndef CONTIKI_TARGET_MAIN
diff --git a/platform/sky/contiki-sky-main.c b/platform/sky/contiki-sky-main.c
index 814520c..5192cb2 100644
--- a/platform/sky/contiki-sky-main.c
+++ b/platform/sky/contiki-sky-main.c
@@ -84,7 +84,9 @@ main(int argc, char **argv)
 #endif
 
   leds_on(LEDS_GREEN);
+#if !DISABLE_DS2411
   ds2411_init();
+#endif
 
   leds_on(LEDS_BLUE);
   xmem_init();
diff --git a/platform/sky/dev/xmem.c b/platform/sky/dev/xmem.c
index 56fc447..901749b 100644
--- a/platform/sky/dev/xmem.c
+++ b/platform/sky/dev/xmem.c
@@ -148,12 +148,20 @@ erase_sector(unsigned long offset)
 void
 xmem_init(void)
 {
+  int s;
   spi_init();
 
   P4DIR |= BV(FLASH_CS) | BV(FLASH_HOLD) | BV(FLASH_PWR);
   P4OUT |= BV(FLASH_PWR);       /* P4.3 Output, turn on power! */
 
+  /* Release from Deep Power-down */
+  s = splhigh();
+  SPI_FLASH_ENABLE();
+  FASTSPI_TX(SPI_FLASH_INS_RES);
+  SPI_WAITFORTx_ENDED();
   SPI_FLASH_DISABLE();		/* Unselect flash. */
+  splx(s);
+
   SPI_FLASH_UNHOLD();
 }
 /*---------------------------------------------------------------------------*/
@@ -191,7 +199,7 @@ xmem_pread(void *_p, int size, unsigned long offset)
   return size;
 }
 /*---------------------------------------------------------------------------*/
-static const char *
+static const unsigned char *
 program_page(unsigned long offset, const unsigned char *p, int nbytes)
 {
   const unsigned char *end = p + nbytes;
-- build log --------
using saved target 'sky'
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../platform/sky/./contiki-sky-main.c -o obj_sky/contiki-sky-main.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../core/sys/process.c -o obj_sky/process.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../core/sys/autostart.c -o obj_sky/autostart.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../core/sys/timer.c -o obj_sky/timer.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../core/sys/etimer.c -o obj_sky/etimer.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../core/sys/energest.c -o obj_sky/energest.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../core/sys/rtimer.c -o obj_sky/rtimer.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../core/lib/ringbuf.c -o obj_sky/ringbuf.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../core/dev/glossy.c -o obj_sky/glossy.o
../../core/dev/glossy.c: In function ‘radio_flush_rx’:
../../core/dev/glossy.c:105:11: warning: variable ‘dummy’ set but not used [-Wunused-but-set-variable]
../../core/dev/glossy.c: In function ‘glossy_prepare_handler’:
../../core/dev/glossy.c:411:3: warning: implicit declaration of function ‘cc2420_set_channel’ [-Wimplicit-function-declaration]
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../cpu/msp430/./msp430.c -o obj_sky/msp430.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../core/dev/leds.c -o obj_sky/leds.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../cpu/msp430/./watchdog.c -o obj_sky/watchdog.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../cpu/msp430/./spi.c -o obj_sky/spi.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../platform/sky/dev/xmem.c -o obj_sky/xmem.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../core/dev/cc2420.c -o obj_sky/cc2420.o
../../core/dev/cc2420.c: In function ‘radio_flush_rx’:
../../core/dev/cc2420.c:62:11: warning: variable ‘dummy’ set but not used [-Wunused-but-set-variable]
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../platform/sky/./node-id.c -o obj_sky/node-id.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../cpu/msp430/dev/uart1.c -o obj_sky/uart1.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../core/dev/ds2411.c -o obj_sky/ds2411.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../core/lib/random.c -o obj_sky/random.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../cpu/msp430/./clock.c -o obj_sky/clock.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../cpu/msp430/./leds-arch.c -o obj_sky/leds-arch.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../cpu/msp430/dev/uart1-putchar.c -o obj_sky/uart1-putchar.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c ../../cpu/msp430/./rtimer-arch.c -o obj_sky/rtimer-arch.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -MMD -c symbols.c -o obj_sky/symbols.o
msp430-ar rcf contiki-sky.a obj_sky/process.o obj_sky/autostart.o obj_sky/timer.o obj_sky/etimer.o obj_sky/energest.o obj_sky/rtimer.o obj_sky/ringbuf.o obj_sky/glossy.o obj_sky/msp430.o obj_sky/leds.o obj_sky/watchdog.o obj_sky/spi.o obj_sky/xmem.o obj_sky/cc2420.o obj_sky/node-id.o obj_sky/uart1.o obj_sky/ds2411.o obj_sky/random.o obj_sky/contiki-sky-main.o obj_sky/clock.o obj_sky/leds-arch.o obj_sky/uart1-putchar.o obj_sky/rtimer-arch.o obj_sky/symbols.o
msp430-gcc -DDEPCOMP18=1 -DLEDS_CONF_ON=0 -DTX_POWER=31 -DRF_CHANNEL=21 -DCRYSTAL_SINK_ID=213 -DSTART_EPOCH=1 -DCRYSTAL_CONF_PERIOD=0.300000 -DN_TX_S=8 -DN_TX_T=5 -DN_TX_A=6 -DDUR_S_MS=17 -DDUR_T_MS=10 -DDUR_A_MS=14 -DCRYSTAL_SYNC_ACKS=1 -DCRYSTAL_SINK_MAX_EMPTY_TS=3 -DCRYSTAL_MAX_SILENT_TAS=3 -DCRYSTAL_MAX_MISSING_ACKS=4 -DCRYSTAL_SINK_MAX_NOISY_TS=6 -DCRYSTAL_USE_DYNAMIC_NEMPTY=0 -DCCA_THRESHOLD=-15 -DCCA_COUNTER_THRESHOLD=80 -DCHHOP_MAPPING=CHMAP_nomap -DBOOT_CHOPPING=BOOT_hop3 -DN_FULL_EPOCHS=100 -DDISABLE_UART=1 -DPRINT_GRAZ=1 -DDISABLE_DS2411=1 -DCRYSTAL_START_DELAY_SINK=0 -DCRYSTAL_START_DELAY_NONSINK=0 -DCONTIKI_TARGET_SKY -Wall -mmcu=msp430f1611 -g  -Os  -I. -I../../platform/sky/. -I../../platform/sky/dev -I../../platform/sky/apps -I../../platform/sky/net -I../../cpu/msp430/. -I../../cpu/msp430/dev -I../../core/dev -I../../core/lib -I../../core/net -I../../core/net/mac -I../../core/net/rime -I../../core/net/routing -I../../core/sys -I../../core/cfs -I../../core/ctk -I../../core/lib/ctk -I../../core/loader -I../../core/. -DAUTOSTART_ENABLE -c crystal.c -o crystal.co
In file included from crystal.c:226:0:
chseq.c: In function ‘get_channel_node_bootstrap’:
chseq.c:79:10: warning: type defaults to ‘int’ in declaration of ‘first_time’ [-Wimplicit-int]
crystal.c: In function ‘process_thread_crystal_test’:
crystal.c:940:3: warning: variable ‘PT_YIELD_FLAG’ set but not used [-Wunused-but-set-variable]
crystal.c: At top level:
crystal.c:236:12: warning: ‘lt_num_rounds’ defined but not used [-Wunused-variable]
crystal.c:237:23: warning: ‘lt_set_time’ defined but not used [-Wunused-variable]
msp430-gcc -mmcu=msp430f1611 -Wl,-Map=contiki-sky.map -Wl,--section-start -Wl,.glossy=0x4000 -Wl,--section-start -Wl,.text=0x4400  crystal.co obj_sky/contiki-sky-main.o contiki-sky.a  -o crystal.sky
rm crystal.co
-- sndtbl.c --------
static const uint8_t sndtbl[] = {2,3,4,5,6};